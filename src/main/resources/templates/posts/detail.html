<!-- src/main/resources/templates/posts/detail.html -->
<!doctype html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>crudboard | Post Detail</title>
    <link rel="stylesheet" href="/css/posts.css">
</head>
<body>
<div class="container">
    <div class="card" id="card">
        <header>
            <div>
                <h1 id="title">-</h1>
                <div class="meta">
                    <span class="pill" id="idPill">ID -</span>
                    <span class="pill" id="createdAt">created -</span>
                    <span class="pill" id="updatedAt">updated -</span>
                    <!-- ✅ 로그인 상태 표시 -->
                    <span class="pill" id="authBadge">guest</span>
                </div>
                <div class="muted" style="margin-top:8px;">내용</div>
            </div>

            <div class="actions">
                <!-- ✅ 홈 화면 진입 -->
                <a class="btn" href="/">홈</a>

                <!-- 기존 네비 -->
                <a class="btn" href="/posts">목록</a>

                <!-- ✅ 비로그인일 때 홈으로 보내서 로그인/회원가입 유도 -->
                <a class="btn" id="loginBtn" href="/" style="display:none;">로그인</a>

                <a class="btn primary" id="editLink" href="#">수정</a>
                <button class="danger" id="deleteBtn">삭제</button>
            </div>
        </header>

        <div class="error" id="errorBox"></div>

        <pre id="content">-</pre>

        <!-- ✅ 댓글 UI (기존 방식 유지) -->
        <div style="margin-top:16px;">
            <div class="row" style="align-items:flex-end;">
                <div style="flex:1;">
                    <label for="commentInput">댓글 작성</label>
                    <textarea id="commentInput" placeholder="댓글을 입력하세요 (Ctrl+Enter로 등록)"></textarea>
                </div>
                <div style="display:flex; flex-direction:column; gap:8px; min-width:180px;">
                    <button class="primary" id="commentCreateBtn">댓글 등록</button>

                    <div class="muted">댓글 페이지 크기</div>
                    <select id="commentSize">
                        <option value="5">5개</option>
                        <option value="10" selected>10개</option>
                        <option value="20">20개</option>
                    </select>
                </div>
            </div>

            <div class="row" style="margin-top:12px;">
                <div class="muted">
                    <span class="pill" id="commentSummary">-</span>
                    <span class="pill" id="commentPageInfo">page - / -</span>
                </div>
                <div class="pager">
                    <button id="commentPrevBtn">이전</button>
                    <button id="commentNextBtn">다음</button>
                </div>
            </div>

            <div id="commentList" style="margin-top:12px;"></div>
        </div>
    </div>
</div>

<script>
    // =========================
    // DOM
    // =========================
    const card = document.getElementById('card');

    const titleEl = document.getElementById('title');
    const contentEl = document.getElementById('content');
    const idPill = document.getElementById('idPill');
    const createdAtEl = document.getElementById('createdAt');
    const updatedAtEl = document.getElementById('updatedAt');

    const authBadge = document.getElementById('authBadge');
    const loginBtn = document.getElementById('loginBtn');

    const editLink = document.getElementById('editLink');
    const deleteBtn = document.getElementById('deleteBtn');
    const errorBox = document.getElementById('errorBox');

    const commentInput = document.getElementById('commentInput');
    const commentCreateBtn = document.getElementById('commentCreateBtn');
    const commentSizeSelect = document.getElementById('commentSize');
    const commentPrevBtn = document.getElementById('commentPrevBtn');
    const commentNextBtn = document.getElementById('commentNextBtn');
    const commentList = document.getElementById('commentList');
    const commentSummary = document.getElementById('commentSummary');
    const commentPageInfo = document.getElementById('commentPageInfo');

    // =========================
    // Utils
    // =========================
    function setLoading(isLoading) {
        card.classList.toggle('loading', isLoading);
        deleteBtn.disabled = isLoading;
        commentCreateBtn.disabled = isLoading;
        commentPrevBtn.disabled = isLoading;
        commentNextBtn.disabled = isLoading;
    }

    function showError(message) {
        errorBox.style.display = 'block';
        errorBox.textContent = message;
    }

    function clearError() {
        errorBox.style.display = 'none';
        errorBox.textContent = '';
    }

    function fmtDate(iso) {
        if (!iso) return '-';
        return String(iso).replace('T', ' ').slice(0, 19);
    }

    function escapeHtml(str) {
        return String(str)
            .replaceAll('&', '&amp;')
            .replaceAll('<', '&lt;')
            .replaceAll('>', '&gt;')
            .replaceAll('"', '&quot;')
            .replaceAll("'", '&#039;');
    }

    function getIdFromPath() {
        // /posts/{id}
        const parts = location.pathname.split('/').filter(Boolean);
        const last = parts[parts.length - 1];
        const id = Number(last);
        return Number.isFinite(id) ? id : null;
    }

    // =========================
    // API paths (네 프로젝트 가정 그대로)
    // =========================
    const API = {
        post: (id) => `/api/posts/${id}`,
        deletePost: (id) => `/api/posts/${id}`,
        comments: (postId) => `/api/posts/${postId}/comments`,
        createComment: (postId) => `/api/posts/${postId}/comments`,
        me: () => `/api/auth/me`,
    };

    // =========================
    // State
    // =========================
    const postId = getIdFromPath();
    const commentState = {
        page: 0,
        size: parseInt(commentSizeSelect.value, 10),
    };

    const authState = {
        isLoggedIn: false,
        user: null,
    };

    if (postId == null) {
        showError('잘못된 접근입니다. (id를 찾을 수 없음)');
        deleteBtn.disabled = true;
        commentCreateBtn.disabled = true;
        commentPrevBtn.disabled = true;
        commentNextBtn.disabled = true;
    } else {
        editLink.href = `/posts/${postId}/edit`;
    }

    // =========================
    // Auth
    // =========================
    async function initAuth() {
        try {
            const res = await fetch(API.me(), { headers: { 'Accept': 'application/json' } });
            if (!res.ok) {
                authState.isLoggedIn = false;
                authState.user = null;
                return;
            }
            const me = await res.json().catch(() => ({}));
            authState.isLoggedIn = true;
            authState.user = me;
        } catch {
            authState.isLoggedIn = false;
            authState.user = null;
        }
    }

    function applyAuthUi() {
        if (authState.isLoggedIn) {
            authBadge.textContent = 'login';
            loginBtn.style.display = 'none';

            // 로그인 시 활성화 (게시글 수정/삭제 + 댓글작성)
            editLink.classList.remove('disabled');
            deleteBtn.disabled = false;
            commentCreateBtn.disabled = false;
        } else {
            authBadge.textContent = 'guest';
            loginBtn.style.display = 'inline-flex';

            // 비로그인 시 비활성화
            editLink.href = '#';
            deleteBtn.disabled = true;
            commentCreateBtn.disabled = true;
        }
    }

    // =========================
    // Post API
    // =========================
    async function fetchPost(id) {
        const res = await fetch(API.post(id), { headers: { 'Accept': 'application/json' } });
        if (!res.ok) {
            const text = await res.text().catch(() => '');
            throw new Error(`게시글 조회 실패 (${res.status})\n${text}`);
        }
        return await res.json();
    }

    async function deletePost(id) {
        const res = await fetch(API.deletePost(id), { method: 'DELETE' });
        if (res.status === 204) return;
        const text = await res.text().catch(() => '');
        throw new Error(`게시글 삭제 실패 (${res.status})\n${text}`);
    }

    function renderPost(post) {
        titleEl.textContent = post.title ?? '-';
        contentEl.textContent = post.content ?? '';
        idPill.textContent = `ID ${post.id ?? '-'}`;
        createdAtEl.textContent = `created ${fmtDate(post.createdAt)}`;
        updatedAtEl.textContent = `updated ${fmtDate(post.updatedAt)}`;
    }

    async function loadPost() {
        const post = await fetchPost(postId);
        renderPost(post);
    }

    // =========================
    // Comment API
    // =========================
    async function fetchComments(postId, state) {
        const params = new URLSearchParams();
        params.set('page', String(state.page));
        params.set('size', String(state.size));
        const url = `${API.comments(postId)}?${params.toString()}`;

        const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
        if (!res.ok) {
            const text = await res.text().catch(() => '');
            throw new Error(`댓글 조회 실패 (${res.status})\n${text}`);
        }
        return await res.json();
    }

    async function createComment(postId, content) {
        const res = await fetch(API.createComment(postId), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content }),
        });

        if (res.status === 201 || res.status === 204) return;

        const text = await res.text().catch(() => '');
        throw new Error(`댓글 등록 실패 (${res.status})\n${text}`);
    }

    function renderComments(page) {
        const items = page?.content ?? [];
        const totalElements = page?.totalElements ?? 0;
        const totalPages = page?.totalPages ?? 0;
        const number = page?.number ?? 0;
        const size = page?.size ?? commentState.size;

        commentSummary.textContent = `댓글 ${totalElements}개`;
        commentPageInfo.textContent = `page ${number + 1} / ${Math.max(totalPages, 1)}`;

        commentPrevBtn.disabled = number <= 0;
        commentNextBtn.disabled = number + 1 >= totalPages;

        if (items.length === 0) {
            commentList.innerHTML = `<div class="muted">아직 댓글이 없어요.</div>`;
            return;
        }

        commentList.innerHTML = items.map(c => {
            const created = fmtDate(c.createdAt);
            const updated = fmtDate(c.updatedAt);
            const content = escapeHtml(c.content ?? '');
            return `
                <div class="card" style="margin:10px 0; box-shadow:none; border:1px solid #eef1f4;">
                    <div class="muted" style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px;">
                        <span class="pill">#${c.id ?? '-'}</span>
                        <span class="pill">created ${created}</span>
                        <span class="pill">updated ${updated}</span>
                    </div>
                    <div style="white-space:pre-wrap; word-break:break-word;">${content}</div>
                </div>
            `;
        }).join('');
    }

    async function loadComments() {
        const page = await fetchComments(postId, commentState);
        renderComments(page);
    }

    // =========================
    // Load all
    // =========================
    async function loadAll() {
        if (postId == null) return;

        clearError();
        setLoading(true);
        try {
            // ✅ auth 먼저 체크해서 UI enable/disable 확정
            await initAuth();
            applyAuthUi();

            await loadPost();
            await loadComments();
        } catch (e) {
            showError(e?.message ?? String(e));
            titleEl.textContent = '-';
            contentEl.textContent = '';
            deleteBtn.disabled = true;

            commentCreateBtn.disabled = true;
            commentPrevBtn.disabled = true;
            commentNextBtn.disabled = true;
            commentList.innerHTML = '';
            commentSummary.textContent = '-';
            commentPageInfo.textContent = 'page - / -';
        } finally {
            setLoading(false);
            applyAuthUi();
        }
    }

    // =========================
    // Events
    // =========================
    deleteBtn.addEventListener('click', async () => {
        if (postId == null) return;

        if (!authState.isLoggedIn) {
            alert('로그인 후 삭제할 수 있어요.');
            location.href = '/';
            return;
        }

        const ok = confirm('정말 게시글을 삭제할까요?');
        if (!ok) return;

        clearError();
        setLoading(true);
        try {
            await deletePost(postId);
            location.href = '/posts';
        } catch (e) {
            showError(e?.message ?? String(e));
        } finally {
            setLoading(false);
            applyAuthUi();
        }
    });

    commentCreateBtn.addEventListener('click', async () => {
        if (postId == null) return;

        if (!authState.isLoggedIn) {
            alert('로그인 후 댓글을 작성할 수 있어요.');
            location.href = '/';
            return;
        }

        const content = (commentInput.value ?? '').trim();
        if (content.length === 0) {
            alert('댓글 내용을 입력해주세요.');
            return;
        }
        if (content.length > 1000) {
            alert('댓글은 최대 1000자까지 입력할 수 있어요.');
            return;
        }

        clearError();
        setLoading(true);
        try {
            await createComment(postId, content);
            commentInput.value = '';
            commentState.page = 0;
            await loadComments();
        } catch (e) {
            showError(e?.message ?? String(e));
        } finally {
            setLoading(false);
            applyAuthUi();
        }
    });

    commentInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
            commentCreateBtn.click();
        }
    });

    commentSizeSelect.addEventListener('change', async () => {
        commentState.size = parseInt(commentSizeSelect.value, 10);
        commentState.page = 0;
        clearError();
        setLoading(true);
        try {
            await loadComments();
        } catch (e) {
            showError(e?.message ?? String(e));
        } finally {
            setLoading(false);
            applyAuthUi();
        }
    });

    commentPrevBtn.addEventListener('click', async () => {
        commentState.page = Math.max(0, commentState.page - 1);
        clearError();
        setLoading(true);
        try {
            await loadComments();
        } catch (e) {
            showError(e?.message ?? String(e));
        } finally {
            setLoading(false);
            applyAuthUi();
        }
    });

    commentNextBtn.addEventListener('click', async () => {
        commentState.page = commentState.page + 1;
        clearError();
        setLoading(true);
        try {
            await loadComments();
        } catch (e) {
            showError(e?.message ?? String(e));
        } finally {
            setLoading(false);
            applyAuthUi();
        }
    });

    loadAll();
</script>
</body>
</html>