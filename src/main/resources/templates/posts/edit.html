<!-- src/main/resources/templates/posts/edit.html -->
<!doctype html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>crudboard | Edit Post</title>
    <link rel="stylesheet" href="/css/posts.css">
</head>
<body>
<div class="container">
    <div class="card" id="card">
        <header>
            <div>
                <h1>수정하기 <span class="pill" id="idPill">ID -</span></h1>
                <div class="muted">PUT /api/posts/{id}</div>
            </div>
            <div class="actions">
                <a class="btn" id="detailLink" href="#">상세</a>
                <a class="btn" href="/posts">목록</a>
            </div>
        </header>

        <div class="error" id="errorBox"></div>

        <form id="form">
            <label for="title">제목</label>
            <input id="title" type="text" maxlength="100" placeholder="제목을 입력하세요" />

            <label for="content">내용</label>
            <textarea id="content" placeholder="내용을 입력하세요"></textarea>

            <div class="row">
                <div class="muted">저장하면 상세 페이지로 이동합니다.</div>
                <button class="primary" id="submitBtn" type="submit">수정 저장</button>
            </div>
        </form>
    </div>
</div>

<script>
    const card = document.getElementById('card');
    const form = document.getElementById('form');
    const titleEl = document.getElementById('title');
    const contentEl = document.getElementById('content');
    const submitBtn = document.getElementById('submitBtn');
    const errorBox = document.getElementById('errorBox');
    const idPill = document.getElementById('idPill');
    const detailLink = document.getElementById('detailLink');

    function setLoading(isLoading) {
        card.classList.toggle('loading', isLoading);
        submitBtn.disabled = isLoading;
    }

    function showError(message) {
        errorBox.style.display = 'block';
        errorBox.textContent = message;
    }

    function clearError() {
        errorBox.style.display = 'none';
        errorBox.textContent = '';
    }

    function fmtDate(iso) {
        if (!iso) return '-';
        return String(iso).replace('T', ' ').slice(0, 19);
    }

    function safeTrim(v) {
        return (v ?? '').toString().trim();
    }

    function getIdFromPath() {
        // /posts/{id}/edit
        const parts = location.pathname.split('/').filter(Boolean);
        const idx = parts.indexOf('posts');
        if (idx === -1 || parts.length < idx + 2) return null;
        const id = Number(parts[idx + 1]);
        return Number.isFinite(id) ? id : null;
    }

    const postId = getIdFromPath();
    if (postId == null) {
        showError('잘못된 접근입니다. (id를 찾을 수 없음)');
        submitBtn.disabled = true;
    } else {
        idPill.textContent = `ID ${postId}`;
        detailLink.href = `/posts/${postId}`;
    }

    async function fetchPost(id) {
        const res = await fetch(`/api/posts/${id}`, {
            headers: { 'Accept': 'application/json' }
        });
        if (!res.ok) {
            const text = await res.text().catch(() => '');
            throw new Error(`조회 실패 (${res.status})\n${text}`);
        }
        return await res.json();
    }

    async function updatePost(id, payload) {
        const res = await fetch(`/api/posts/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(payload)
        });

        if (res.status === 204) return;
        const text = await res.text().catch(() => '');
        throw new Error(`수정 실패 (${res.status})\n${text}`);
    }

    function fillForm(post) {
        titleEl.value = post.title ?? '';
        contentEl.value = post.content ?? '';
    }

    async function load() {
        if (postId == null) return;
        clearError();
        setLoading(true);
        try {
            const post = await fetchPost(postId);
            fillForm(post);
        } catch (e) {
            showError(e?.message ?? String(e));
            submitBtn.disabled = true;
        } finally {
            setLoading(false);
        }
    }

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (postId == null) return;

        clearError();
        const title = safeTrim(titleEl.value);
        const content = safeTrim(contentEl.value);

        // 프론트 1차 검증(서버 검증이 최종)
        if (!title) return showError('title은 필수입니다.');
        if (!content) return showError('content는 필수입니다.');

        setLoading(true);
        try {
            await updatePost(postId, { title, content });
            window.location.href = `/posts/${postId}`;
        } catch (err) {
            showError(err?.message ?? String(err));
        } finally {
            setLoading(false);
        }
    });

    load();
</script>
</body>
</html>