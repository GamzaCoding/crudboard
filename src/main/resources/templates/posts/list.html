<!-- src/main/resources/templates/posts/list.html -->
<!doctype html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>crudboard | Posts</title>
    <link rel="stylesheet" href="/css/posts.css">
</head>
<body>
<div class="container">
    <div class="card" id="card">
        <header>
            <div>
                <h1>게시글 목록</h1>
                <div class="muted" id="summary">-</div>
            </div>
            <div class="actions">
                <input id="keyword" type="text" placeholder="검색어 (title/content)" />
                <select id="size">
                    <option value="5">5개</option>
                    <option value="10">10개</option>
                    <option value="20">20개</option>
                    <option value="50">50개</option>
                </select>
                <button id="searchBtn">검색</button>
                <a class="btn primary" href="/posts/new">글쓰기</a>
            </div>
        </header>

        <div class="error" id="errorBox"></div>

        <table aria-label="posts">
            <thead>
            <tr>
                <th style="width: 80px;">ID</th>
                <th>제목</th>
                <th style="width: 190px;">작성일</th>
                <th style="width: 190px;">수정일</th>
            </tr>
            </thead>
            <tbody id="tbody">
            <!-- rows injected -->
            </tbody>
        </table>

        <div class="footer">
            <div class="muted">
                <span class="pill" id="pageInfo">page - / -</span>
            </div>
            <div class="pager">
                <button id="prevBtn">이전</button>
                <button id="nextBtn">다음</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- State & DOM ---
    const card = document.getElementById('card');
    const tbody = document.getElementById('tbody');
    const summary = document.getElementById('summary');
    const pageInfo = document.getElementById('pageInfo');
    const errorBox = document.getElementById('errorBox');

    const keywordInput = document.getElementById('keyword');
    const sizeSelect = document.getElementById('size');
    const searchBtn = document.getElementById('searchBtn');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');

    // URL query 기반으로 상태 유지 (새로고침/공유에 좋음)
    function readStateFromUrl() {
        const params = new URLSearchParams(location.search);
        const page = parseInt(params.get('page') ?? '0', 10);
        const size = parseInt(params.get('size') ?? '5', 10);
        const keyword = params.get('keyword') ?? '';
        return {
            page: Number.isFinite(page) && page >= 0 ? page : 0,
            size: [5,10,20,50].includes(size) ? size : 5,
            keyword
        };
    }

    function writeStateToUrl(state) {
        const params = new URLSearchParams();
        params.set('page', String(state.page));
        params.set('size', String(state.size));
        if (state.keyword && state.keyword.trim().length > 0) params.set('keyword', state.keyword.trim());
        history.replaceState(null, '', `${location.pathname}?${params.toString()}`);
    }

    function fmtDate(iso) {
        if (!iso) return '-';
        // "2026-02-03T20:12:08.234895" 같은 LocalDateTime 문자열도 Date로 파싱이 될 수 있지만,
        // 브라우저마다 애매할 수 있어 간단히 앞부분만 표시.
        // 필요하면 서버에서 ISO_OFFSET_DATE_TIME으로 보내는 방식으로 개선 가능.
        return String(iso).replace('T', ' ').slice(0, 19);
    }

    function setLoading(isLoading) {
        card.classList.toggle('loading', isLoading);
        searchBtn.disabled = isLoading;
        prevBtn.disabled = isLoading;
        nextBtn.disabled = isLoading;
    }

    function showError(message) {
        errorBox.style.display = 'block';
        errorBox.textContent = message;
    }

    function clearError() {
        errorBox.style.display = 'none';
        errorBox.textContent = '';
    }

    // --- API ---
    async function fetchPosts(state) {
        // 서버에서 기본 정렬을 이미 걸어뒀다면 sort 파라미터는 굳이 안 보내도 됨.
        // 그래도 명시적으로 보내고 싶으면 아래 주석 해제:
        // params.set('sort', 'createdAt,desc');

        const params = new URLSearchParams();
        params.set('page', String(state.page));
        params.set('size', String(state.size));
        if (state.keyword && state.keyword.trim().length > 0) params.set('keyword', state.keyword.trim());

        const res = await fetch(`/api/posts?${params.toString()}`, {
            headers: { 'Accept': 'application/json' }
        });

        if (!res.ok) { // 200-299가 아니면 false
            const text = await res.text().catch(() => '');
            throw new Error(`API 요청 실패 (${res.status})\n${text}`);
        }

        return await res.json();
    }

    // --- Render ---
    function renderTable(pageResponse) {
        tbody.innerHTML = '';

        const rows = pageResponse.content ?? [];
        if (rows.length === 0) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td colspan="4" class="muted" style="padding:16px;">게시글이 없습니다.</td>`;
            tbody.appendChild(tr);
            return;
        }

        for (const post of rows) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
        <td class="muted">${post.id ?? '-'}</td>
        <td>
          <div style="font-weight:600; margin-bottom:4px;">${escapeHtml(post.title ?? '')}</div>
          <div class="muted" style="max-width: 520px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
            ${escapeHtml(post.content ?? '')}
          </div>
        </td>
        <td class="muted">${fmtDate(post.createdAt)}</td>
        <td class="muted">${fmtDate(post.updatedAt)}</td>
      `;
            tr.addEventListener('click', () => {
                if (post.id == null) return;
                location.href = `/posts/${post.id}`;
            });
            tbody.appendChild(tr);
        }
    }

    function renderMeta(pageResponse, state) {
        const totalElements = pageResponse.totalElements ?? 0;
        const totalPages = pageResponse.totalPages ?? 0;
        const number = pageResponse.number ?? state.page; // 현재 페이지(0-based)
        const size = pageResponse.size ?? state.size;
        const numberOfElements = pageResponse.numberOfElements ?? (pageResponse.content?.length ?? 0);

        summary.textContent = `총 ${totalElements}개 · 현재 ${numberOfElements}개 표시`;
        pageInfo.textContent = `page ${number + 1} / ${Math.max(totalPages, 1)} · size ${size}`;

        // first/last가 있으면 그걸 우선 사용
        const first = pageResponse.first ?? (number <= 0);
        const last = pageResponse.last ?? (totalPages > 0 ? number >= totalPages - 1 : true);

        prevBtn.disabled = first;
        nextBtn.disabled = last;
    }

    // XSS 방지용 최소 escape
    function escapeHtml(str) {
        return String(str)
            .replaceAll('&', '&amp;')
            .replaceAll('<', '&lt;')
            .replaceAll('>', '&gt;')
            .replaceAll('"', '&quot;')
            .replaceAll("'", '&#039;');
    }

    // --- Actions ---
    let state = readStateFromUrl();
    keywordInput.value = state.keyword;
    sizeSelect.value = String(state.size);

    async function load() {
        clearError();
        setLoading(true);
        writeStateToUrl(state);

        try {
            const data = await fetchPosts(state);
            renderTable(data);
            renderMeta(data, state);
        } catch (e) {
            showError(e?.message ?? String(e));
            // 실패 시에도 버튼 상태는 최소한 복구
            prevBtn.disabled = true;
            nextBtn.disabled = true;
            summary.textContent = '-';
            pageInfo.textContent = 'page - / -';
            tbody.innerHTML = '';
        } finally {
            setLoading(false);
        }
    }

    searchBtn.addEventListener('click', () => {
        state.keyword = keywordInput.value;
        state.size = parseInt(sizeSelect.value, 10);
        state.page = 0; // 검색하면 첫 페이지로
        load();
    });

    keywordInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') searchBtn.click();
    });

    sizeSelect.addEventListener('change', () => {
        state.size = parseInt(sizeSelect.value, 10);
        state.page = 0;
        load();
    });

    prevBtn.addEventListener('click', () => {
        state.page = Math.max(0, state.page - 1);
        load();
    });

    nextBtn.addEventListener('click', () => {
        state.page = state.page + 1;
        load();
    });

    // initial load
    load();
</script>
</body>
</html>